#!/usr/bin/env node
const fs = require("fs");
const path = require("path");
const { تحليل_الشفرة } = require("./src/lexer");
const { محلل_الرموز } = require("./src/parser");
const { توليد_كود } = require("./src/generator");
const http = require("http");

// المدخلات في الطرفية
const command = process.argv[2];
if (["--version", "ص", "اصدار"].includes(command)) {
    console.log("0.1.0 اصدار لغة الف للويب");
} else if (["--help", "م", "مساعدة"].includes(command)) {
    console.log(`
    اصدار - ص: اصدار اللغة.
    مساعدة - م: اظهار هاذه القائمة
    اسم_الملف.الف: تشغيل ملف محدد.
    عدم كتابة شئ: تشغيل ملف رئيسي.الف.
    `);
} else {
    if (["alif", "الف"].includes(command)) {
        runAlif(command);
    } else {
        runAlif();
    }
}

function runAlif(fileName) {
    const مسار_الملف = path.join(
        __dirname,
        fileName ? fileName : "./رئيسي.الف"
    );
    fs.readFile(مسار_الملف, "utf8", (خطأ, شفرة) => {
        if (خطأ) {
            console.error("خطأ في قراءة الملف:", خطأ);
            return;
        }

        const رموز = تحليل_الشفرة(شفرة);
        const ast = محلل_الرموز(رموز);
        const كود_js = توليد_كود(ast);
        const server = http.createServer((req, res) => {
            res.writeHead(200, { "Content-Type": "text/html" });
            res.end(`
              <!DOCTYPE html>
              <html lang="ar">
              <head>
                <meta charset="UTF-8">
                <meta name="viewport" content="width=device-width, initial-scale=1.0">
                <title>لغة ألف</title>
              </head>
              <body>
                <script>${كود_js}</script>
              </body>
              </html>
            `);
        });

        server.listen(3000, () => {
            console.log("السيرفر يعمل على http://localhost:3000");
        });
    });
}
