function محلل_الرموز(رموز) {
    let الموشر = 0;

    function احصل() {
        return رموز[الموشر];
    }

    function التالي() {
        الموشر++;
        return احصل();
    }

    function تحقق(النوع, القيمة = null) {
        const رمز = احصل();
        if (!رمز) return false;
        if (رمز.النوع !== النوع) return false;
        if (القيمة !== null && رمز.القيمة !== القيمة) return false;
        return true;
    }

    function تطابق(النوع, القيمة = null) {
        if (تحقق(النوع, القيمة)) {
            const الرمز = احصل();
            التالي();
            return الرمز;
        }
        return null;
    }

    function محلل_العملية() {
        let يسار = محلل_التعبير();

        while (تحقق("رمز_حسابي")) {
            const عامل = التالي();
            const يمين = محلل_التعبير();

            يسار = {
                نوع: "عملية",
                يسار: يسار,
                عامل: عامل.القيمة,
                يمين: يمين,
            };
        }

        return يسار;
    }

    function محلل_التعبير() {
        const رمز = احصل();

        if (تحقق("كلمة", "صح")) {
            التالي();
            return { نوع: "قيمة", قيمة: true };
        }
        if (تحقق("كلمة", "خطأ")) {
            التالي();
            return { نوع: "قيمة", قيمة: false };
        }
        if (تحقق("كلمة", "عدم")) {
            التالي();
            return { نوع: "قيمة", قيمة: null };
        }

        if (تحقق("رقم") || تحقق("نص") || تحقق("معرف")) {
            return { نوع: "قيمة", قيمة: احصل().القيمة, رمز: التالي() };
        }

        if (تحقق("معرف")) {
            return { نوع: "معرف", اسم: التالي().قيمة };
        }

        if (تحقق("اقواس", "(")) {
            التالي();
            const تعبير = محلل_التعبير();
            تطابق("اقواس", ")");
            return تعبير;
        }

        console.warn(`تحذير: تعبير غير مفهوم عند السطر ${رمز?.سطر}`);
        التالي(); // عشان ما يحصلش توقف لا نهائي
        return { نوع: "غير_معروف", رمز };
    }

    function محلل_عام_للاقواس(الكلمة) {
        تطابق("كلمة", الكلمة);
        تطابق("اقواس", "(");
        const قيمة = محلل_العملية();
        تطابق("اقواس", ")");
        return { نوع: الكلمة, قيمة };
    }

    function محلل_عام_للاقواس_يسبقها_نقطة(الكلمة) {
        let متغير = تطابق("معرف");
        تطابق("اقواس", ".");
        تطابق("كلمة", الكلمة);
        تطابق("اقواس", "(");
        const قيمة = محلل_العملية();
        if ((الكلمة = "مفتاح")) {
            قيمة = "";
        } else {
            قيمة = محلل_العملية();
        }
        تطابق("اقواس", ")");
        return { نوع: الكلمة, قيمة, المتغير: متغير };
    }

    function محلل_الطباعة() {
        return محلل_عام_للاقواس("اطبع");
    }
    function محلل_ادخل() {
        return محلل_عام_للاقواس("ادخل");
    }
    function محلل_طول() {
        return محلل_عام_للاقواس("طول");
    }
    function محلل_اقصى() {
        return محلل_عام_للاقواس("اقصى");
    }
    function محلل_ادنى() {
        return محلل_عام_للاقواس("ادنى");
    }
    function محلل_اشعار() {
        return محلل_عام_للاقواس("اشعار");
    }
    function محلل_النص() {
        return محلل_عام_للاقواس("نص");
    }

    function محلل_اضف() {
        return محلل_عام_للاقواس_يسبقها_نقطة("اضف");
    }
    function محلل_امسح() {
        return محلل_عام_للاقواس_يسبقها_نقطة("امسح");
    }
    function محلل_ادرج() {
        return محلل_عام_للاقواس_يسبقها_نقطة("ادرج");
    }
    function محلل_مفاتيح() {
        return محلل_عام_للاقواس_يسبقها_نقطة("مفاتيح");
    }

    function محلل_متغير() {
        const معرف = تطابق("معرف");
        if (معرف && تحقق("علامة_إسناد", "=")) {
            تطابق("علامة_إسناد", "=");
            const قيمة = محلل_العملية();
            return { نوع: "متغير", اسم: معرف.القيمة, قيمة };
        }
        if (معرف) {
            الموشر--;
        }
        return null;
    }

    function محلل_دالة() {
        تطابق("كلمة", "دالة");

        const الاسم = تطابق("معرف");
        if (!الاسم) throw new Error("يجب تحديد اسم للدالة");

        تطابق("اقواس", "(");
        const المعاملات = [];
        while (!تحقق("اقواس", ")")) {
            const معرف = تطابق("معرف");
            if (معرف) المعاملات.push(معرف.القيمة);
            if (تحقق("فاصلة")) التالي();
        }
        تطابق("اقواس", ")");

        if (!تطابق("اقواس", ":")) {
            console.error(`توقعت ":" بعد تعريف الدالة`);
        }

        const جسم = [];
        while (
            الموشر < رموز.length &&
            !تحقق("كلمة", "دالة") &&
            !تحقق("كلمة", "نهاية")
        ) {
            if (تحقق("سطر_جديد")) {
                التالي();
                continue;
            }
            جسم.push(محلل_جملة());
        }

        return {
            نوع: "دالة",
            اسم: الاسم.القيمة,
            معاملات: المعاملات,
            جسم: جسم,
        };
    }

    function محلل_الارجاع() {
        تطابق("كلمة", "ارجع");
        const قيمة = محلل_التعبير();
        return { نوع: "ارجع", قيمة };
    }
    function محلل_استورد() {
        تطابق("كلمة", "استورد");
        const قيمة = محلل_التعبير();
        return { نوع: "استورد", قيمة };
    }

    function محلل_الاذا() {
        تطابق("كلمة", "اذا");
        const شرط = محلل_التعبير();
        تطابق("اقواس", ":");

        const جسم = [];
        while (!تحقق("كلمة", "والا") && الموشر < رموز.length) {
            if (تحقق("سطر_جديد")) {
                التالي();
                continue;
            }
            جسم.push(محلل_جملة());
        }

        let والا_جسم = null;
        if (تطابق("كلمة", "والا")) {
            تطابق("اقواس", ":");
            والا_جسم = [];
            while (تحقق("سطر_جديد")) التالي();
            while (موشر < رموز.length && !تحقق("كلمة", "اذا")) {
                if (تحقق("سطر_جديد")) {
                    التالي();
                    continue;
                }
                والا_جسم.push(محلل_جملة());
            }
        }

        return { نوع: "اذا", شرط, جسم, والا: والا_جسم };
    }

    function محلل_جملة() {
        const المحللات = {
            اطبع: محلل_الطباعة,
            نص: محلل_النص,
            ادخل: محلل_ادخل,
            طول: محلل_طول,
            ادني: محلل_ادنى,
            اقصى: محلل_اقصى,
            اشعار: محلل_اشعار,
            اضف: محلل_اضف,
            امسح: محلل_امسح,
            ادرج: محلل_ادرج,
            مفاتيح: محلل_مفاتيح,
            متغير: محلل_متغير,
            دالة: محلل_دالة,
            استورد: محلل_استورد,
            ارجع: محلل_الارجاع,
            اذا: محلل_الاذا,
        };

        const كلمة = احصل()?.القيمة;
        if (كلمة && المحللات[كلمة]) return المحللات[كلمة]();

        const متغير = محلل_متغير();
        if (متغير) return متغير;

        const رمز = احصل();
        console.error(`جملة غير مفهومة عند السطر ${رمز?.سطر}:`, رمز);
        التالي(); // عشان يتخطى الرمز الغريب
        return { نوع: "غير_معروف", رمز };
    }

    function ابدأ() {
        const جمل = [];
        while (الموشر < رموز.length) {
            if (تحقق("سطر_جديد")) {
                التالي();
                continue;
            }
            جمل.push(محلل_جملة());
        }
        return { نوع: "برنامج", جمل };
    }

    return ابدأ();
}

module.exports = { محلل_الرموز };
