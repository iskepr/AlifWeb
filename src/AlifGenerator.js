function توليد_كود(ast, مستوى = 0, عداد = { قيمة: 0 }, داخل_برنامج = false) {
    const مولدات = {
        برنامج: (عقدة) => {
            const كود = عقدة.جمل
                .map((ج) => توليد_كود(ج, مستوى, عداد, true))
                .join("\n");
            return (
                `const __fragment = document.createDocumentFragment();\n` +
                `${كود}\n` +
                `document.body.appendChild(__fragment);`
            );
        },

        متغير: (عقدة) => {
            const الاسم = عقدة.اسم;
            const القيمة = توليد_كود(عقدة.قيمة, مستوى, عداد);
            // تتبع المتغيرات المعلنة لتجنّب إعادة let
            if (!عداد.declaredVars) عداد.declaredVars = new Set();
            if (عداد.declaredVars.has(الاسم)) {
                return `${الاسم} = ${القيمة};`;
            } else {
                عداد.declaredVars.add(الاسم);
                return `let ${الاسم} = ${القيمة};`;
            }
        },

        اطبع: (عقدة) => `console.log(${توليد_كود(عقدة.قيمة, مستوى, عداد)});`,
        ادخل: (عقدة) => `prompt(${توليد_كود(عقدة.قيمة, مستوى, عداد)})`,
        طول: (عقدة) =>`Object.keys(${توليد_كود(عقدة.قيمة, مستوى, عداد)}).length`,
        اقصى: (عقدة) => `Math.max(...${توليد_كود(عقدة.قيمة, مستوى, عداد)})`,
        ادنى: (عقدة) => `Math.min(...${توليد_كود(عقدة.قيمة, مستوى, عداد)})`,
        اشعار: (عقدة) => `alert(${توليد_كود(عقدة.قيمة, مستوى, عداد)});`,
        صحيح: (عقدة) => `parseInt(${توليد_كود(عقدة.قيمة, مستوى, عداد)})`,
        عشري: (عقدة) => `parseFloat(${توليد_كود(عقدة.قيمة, مستوى, عداد)})`,
        مصفوفة: (عقدة) => `JSON.parse(${توليد_كود(عقدة.قيمة, مستوى, عداد)})`,

        اضف: (عقدة) => {
            if (!عقدة?.المتغير || !عقدة?.قيمة) {
                console.error("خطأ: المتغير أو القيمة غير معرّفة");
                return "// خطأ: المتغير أو القيمة غير معرّفة";
            }
            return `${توليد_كود(عقدة.المتغير, مستوى, عداد)}.push(${توليد_كود(
                عقدة.قيمة,
                مستوى,
                عداد
            )});`;
        },
        امسح: (عقدة) => {
            if (!عقدة?.المتغير || !عقدة?.قيمة) {
                console.error("خطأ: المتغير أو القيمة غير معرّفة");
                return "// خطأ: المتغير أو القيمة غير معرّفة";
            }
            return `const index = ${توليد_كود(
                عقدة.المتغير,
                مستوى,
                عداد
            )}.indexOf(${توليد_كود(
                عقدة.قيمة,
                مستوى,
                عداد
            )});if (index > -1) {${توليد_كود(
                عقدة.المتغير,
                مستوى,
                عداد
            )}.splice(index, 1);}`;
        },
        ادرج: (عقدة) => {
            if (!عقدة?.المتغير || !عقدة?.موقع || !عقدة?.قيمة) {
                console.error("خطأ: المتغير أو الموقع أو القيمة غير معرّفة");
                return "// خطأ: المتغير أو الموقع أو القيمة غير معرّفة";
            }
            return `${توليد_كود(عقدة.المتغير, مستوى, عداد)}.splice(${توليد_كود(
                عقدة.موقع,
                مستوى,
                عداد
            )}, 0, ${توليد_كود(عقدة.قيمة, مستوى, عداد)});`;
        },
        مفاتيح: (عقدة) => {
            if (!عقدة?.المتغير || !عقدة?.قيمة) {
                console.error("خطأ: المتغير أو القيمة غير معرّفة");
                return "// خطأ: المتغير أو القيمة غير معرّفة";
            }
            return `Object.keys(${توليد_كود(عقدة.المتغير, مستوى, عداد)})`;
        },

        ارجع: (عقدة) => `return ${توليد_كود(عقدة.قيمة, مستوى, عداد)};`,
        استورد: (عقدة) => `import "${توليد_كود(عقدة.قيمة, مستوى, عداد)}";`,
        عام: (عقدة) => ``,
        استمر: (عقدة) => `continue;`,
        توقف: (عقدة) => `break;`,
        صح: (عقدة) => `true`,
        خطا: (عقدة) => `false`,
        عدم: (عقدة) => `null`,

        دالة: (عقدة) => {
            // console.log("--------------دالة---------------", عقدة);
            const اسم = عقدة.اسم;
            const معاملات = (عقدة.معاملات || []).join(", ");
            const جسم = عقدة.جسم
                .map((ج) => توليد_كود(ج, مستوى + 1, عداد, داخل_برنامج))
                .join("\n");
            return `function ${اسم}(${معاملات}) {\n${جسم}\n}`;
        },
        اذا: (عقدة) => {
            const شرط = توليد_كود(عقدة.شرط, 0, عداد);
            const جسم = عقدة.جسم
                .map((ج) => توليد_كود(ج, مستوى + 1, عداد, داخل_برنامج))
                .join("\n");
            return `if (${شرط}) {\n${جسم}\n}`;
        },
        بينما: (عقدة) => {
            const شرط = توليد_كود(عقدة.شرط, 0, عداد);
            const جسم = عقدة.جسم
                .map((ج) => توليد_كود(ج, مستوى + 1, عداد, داخل_برنامج))
                .join("\n");
            return `while (${شرط}) {\n${جسم}\n}`;
        },

        قيمة: (عقدة) => {
            const v = عقدة.قيمة;
            if (typeof v === "boolean") return v ? "صح" : "خطا";
            if (v === null) return "عدم";
            if (!isNaN(v)) return v;
            return v;
        },
        معرف: (عقدة) => `${عقدة.اسم}`,
        عملية: (عقدة) => {
            const يسار = توليد_كود(عقدة.يسار, 0, عداد);
            const يمين = توليد_كود(عقدة.يمين, 0, عداد);
            const عامل = عقدة.عامل;
            return `(${يسار} ${عامل} ${يمين})`;
        },
        تعابيرات: (عقدة) => {
            const list = عقدة.قيم.map((v) => توليد_كود(v, 0, عداد)).join(", ");
            return `[${list}]`;
        },
        كائن: (عقدة) => {
            const props = عقدة.خصائص
                .map(
                    ({ key, value }) => `"${key}": ${توليد_كود(value, 0, عداد)}`
                )
                .join(", ");
            return `{${props}}`;
        },
        قائمة: (عقدة) => {
            const قيم = عقدة.قيم
                .map(
                    ({ value }) => `${توليد_كود(value, 0, عداد)}`
                )
                .join(", ");
            return `[${قيم}]`;
        },
        قائمة_اقواس: (عقدة) => {
            const قيم = عقدة.قيم
                .map(
                    ({ value }) => `${توليد_كود(value, 0, عداد)}`
                )
                .join(", ");
            return `(${قيم})`;
        },

        // html
        نص: (عقدة) => {
            عداد.قيمة++;
            const قيم = عقدة.قيم.map(({ value }) => توليد_كود(value, 0, عداد));
            const اسم = `عنصر${عداد.قيمة}`;
            const سطر1 = `const ${اسم} = document.createElement("p");`;
            const سطر2 = `${اسم}.innerHTML = ${قيم[0]};`;
            const سطر3 = `${اسم}.style = ${ قيم[1]};`;
            const سطر4 = داخل_برنامج
                ? `__fragment.appendChild(${اسم});`
                : `document.body.appendChild(${اسم});`;
            return [سطر1, سطر2, سطر3, سطر4].join("\n");
        },
        رابط: (عقدة) => {
            عداد.قيمة++;
            const قيم = عقدة.قيم.map(({ value }) => توليد_كود(value, 0, عداد));
            const اسم = `عنصر${عداد.قيمة}`;
            const سطر1 = `const ${اسم} = document.createElement("a");`;
            const سطر2 = `${اسم}.innerHTML = ${ قيم[0]};`;
            const سطر3 = `${اسم}.href = ${ قيم[1]};`;
            const سطر4 = `${اسم}.style = ${ قيم[2]};`;
            const سطر5 = داخل_برنامج
                ? `__fragment.appendChild(${اسم});`
                : `document.body.appendChild(${اسم});`;
            return [سطر1, سطر2, سطر3, سطر4, سطر5].join("\n");
        },
    };

    const مولد = مولدات[ast.نوع];
    if (!مولد) {
        console.error("نوع غير مدعوم: " + ast.نوع);
        return `// خطأ: نوع غير مدعوم (${ast.نوع})`;
    }
    const خطوط = مولد(ast).split("\n");
    return خطوط.map((خط) => `${خط}`).join("\n");
}

module.exports = { توليد_كود };
