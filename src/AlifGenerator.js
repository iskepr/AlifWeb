function توليد_كود(ast, مستوى = 0, عداد = { قيمة: 0 }, داخل_برنامج = false) {
    const مولدات = {
        برنامج: (عقدة) => {
            const كود = عقدة.جمل
                .map((ج) => توليد_كود(ج, مستوى, عداد, true))
                .join("\n");
            return (
                `const __fragment = document.createDocumentFragment();\n` +
                `${كود}\n` +
                `document.body.appendChild(__fragment);`
            );
        },

        اطبع: (عقدة) => `console.log(${توليد_كود(عقدة.قيمة, مستوى, عداد)});`,

        ادخل: (عقدة) => `prompt(${توليد_كود(عقدة.قيمة, مستوى, عداد)});`,

        طول: (عقدة) => `${توليد_كود(عقدة.قيمة, مستوى, عداد)}.length`,

        اقصى: (عقدة) => `console.log(${توليد_كود(عقدة.قيمة, مستوى, عداد)});`,

        ادنى: (عقدة) => `console.log(${توليد_كود(عقدة.قيمة, مستوى, عداد)});`,

        اشعار: (عقدة) => `alert(${توليد_كود(عقدة.قيمة, مستوى, عداد)});`,

        اضف: (عقدة) => {
            if (!عقدة?.المتغير || !عقدة?.قيمة) {
                console.error("خطأ: المتغير أو القيمة غير معرّفة");
                return "// خطأ: المتغير أو القيمة غير معرّفة";
            }
            return `${توليد_كود(عقدة.المتغير, مستوى, عداد)}.push(${توليد_كود(
                عقدة.قيمة,
                مستوى,
                عداد
            )});`;
        },
        امسح: (عقدة) => {
            if (!عقدة?.المتغير || !عقدة?.قيمة) {
                console.error("خطأ: المتغير أو القيمة غير معرّفة");
                return "// خطأ: المتغير أو القيمة غير معرّفة";
            }
            return `const index = ${توليد_كود(
                عقدة.المتغير,
                مستوى,
                عداد
            )}.indexOf(${توليد_كود(
                عقدة.قيمة,
                مستوى,
                عداد
            )});if (index > -1) {${توليد_كود(
                عقدة.المتغير,
                مستوى,
                عداد
            )}.splice(index, 1);}`;
        },
        ادرج: (عقدة) => {
            if (!عقدة?.المتغير || !عقدة?.موقع || !عقدة?.قيمة) {
                console.error("خطأ: المتغير أو الموقع أو القيمة غير معرّفة");
                return "// خطأ: المتغير أو الموقع أو القيمة غير معرّفة";
            }
            return `${توليد_كود(عقدة.المتغير, مستوى, عداد)}.splice(${توليد_كود(
                عقدة.موقع,
                مستوى,
                عداد
            )}, 0, ${توليد_كود(عقدة.قيمة, مستوى, عداد)});`;
        },
        مفاتيح: (عقدة) => {
            if (!عقدة?.المتغير || !عقدة?.قيمة) {
                console.error("خطأ: المتغير أو القيمة غير معرّفة");
                return "// خطأ: المتغير أو القيمة غير معرّفة";
            }
            return `Object.keys(${توليد_كود(عقدة.المتغير, مستوى, عداد)})`;
        },

        نص: (عقدة) => {
            عداد.قيمة++;
            const اسم = `عنصر${عداد.قيمة}`;
            const محتوى = توليد_كود(عقدة.قيمة, مستوى, عداد);
            const سطر1 = `const ${اسم} = document.createElement("p");`;
            const سطر2 = `${اسم}.innerHTML = ${محتوى};`;
            const سطر3 = داخل_برنامج
                ? `__fragment.appendChild(${اسم});`
                : `document.body.appendChild(${اسم});`;
            return [سطر1, سطر2, سطر3].join("\n");
        },

        دالة: (عقدة) => {
            // console.log("--------------دالة---------------", عقدة);
            const اسم = عقدة.اسم;
            const معاملات = (عقدة.معاملات || []).join(", ");
            const جسم = عقدة.جسم
                .map((ج) => توليد_كود(ج, مستوى + 1, عداد, داخل_برنامج))
                .join("\n");
            return `function ${اسم}(${معاملات}) {\n${جسم}\n}`;
        },

        ارجع: (عقدة) => `return ${توليد_كود(عقدة.قيمة, مستوى, عداد)};`,
        استورد: (عقدة) => `import "${توليد_كود(عقدة.قيمة, مستوى, عداد)}";`,

        اذا: (عقدة) => {
            const شرط = توليد_كود(عقدة.شرط, 0, عداد);
            const جسم = عقدة.جسم
                .map((ج) => توليد_كود(ج, مستوى + 1, عداد, داخل_برنامج))
                .join("\n");
            return `if (${شرط}) {\n${جسم}\n}`;
        },

        بينما: (عقدة) => {
            const شرط = توليد_كود(عقدة.شرط, 0, عداد);
            const جسم = عقدة.جسم
                .map((ج) => توليد_كود(ج, مستوى + 1, عداد, داخل_برنامج))
                .join("\n");
            return `while (${شرط}) {\n${جسم}\n}`;
        },

        قيمة: (عقدة) => {
            const v = عقدة.قيمة;
            if (typeof v === "boolean") return v ? "صح" : "خطا";
            if (v === null) return "null";
            if (!isNaN(v)) return v;
            return v;
        },

        متغير: (عقدة) => {
            const الاسم = عقدة.اسم;
            const القيمة = توليد_كود(عقدة.قيمة, مستوى, عداد);
            return `let ${الاسم} = ${القيمة};`;
        },

        معرف: (عقدة) => `${عقدة.اسم}`,

        عملية: (عقدة) => {
            const يسار = توليد_كود(عقدة.يسار, 0, عداد);
            const يمين = توليد_كود(عقدة.يمين, 0, عداد);
            const عامل = عقدة.عامل;
            return `(${يسار} ${عامل} ${يمين})`;
        },
    };

    const مولد = مولدات[ast.نوع];
    if (!مولد) {
        console.error("نوع غير مدعوم: " + ast.نوع);
        return `// خطأ: نوع غير مدعوم (${ast.نوع})`;
    }
    const خطوط = مولد(ast).split("\n");
    return خطوط.map((خط) => `${خط}`).join("\n");
}

module.exports = { توليد_كود };
