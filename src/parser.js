function محلل_الرموز(رموز) {
    console.log(رموز)
    let الموشر = 0;

    function احصل() {
        return رموز[الموشر];
    }

    function التالي() {
        الموشر++;
        return احصل();
    }

    function تحقق(النوع, القيمة = null) {
        const رمز = احصل();
        if (!رمز) return false;
        if (رمز.النوع !== النوع) return false;
        if (القيمة !== null && رمز.القيمة !== القيمة) return false;
        return true;
    }

    function تطابق(النوع, القيمة = null) {
        if (تحقق(النوع, القيمة)) {
            return التالي();
        }
        return null;
    }

    function محلل_التعبير() {
        const رمز = احصل();

        if (
            تحقق("رقم") ||
            تحقق("نص") ||
            تحقق("كلمة", "صح") ||
            تحقق("كلمة", "خطأ") ||
            تحقق("كلمة", "عدم")
        ) {
            return { نوع: "قيمة", قيمة: احصل().القيمة, رمز: التالي() };
        }
        
        if (تحقق("معرف")) {
            return { نوع: "معرف", اسم: التالي().قيمة };
        }

        console.warn(`تحذير: تعبير غير مفهوم عند السطر ${رمز?.سطر}`);
        التالي(); // عشان ما يحصلش توقف لا نهائي
        return { نوع: "غير_معروف", رمز };
    }

    function محلل_الطباعة() {
        تطابق("كلمة", "اطبع");
        تطابق("اقواس", "(");
        const قيمة = محلل_التعبير();
        تطابق("اقواس", ")");
        return { نوع: "اطبع", قيمة };
    }

    function محلل_النص() {
        تطابق("كلمة", "نص");
        تطابق("اقواس", "(");
        const قيمة = محلل_التعبير();
        تطابق("اقواس", ")");
        return { نوع: "نص", قيمة };
    }

    function محلل_الارجاع() {
        تطابق("كلمة", "ارجع");
        const قيمة = محلل_التعبير();
        return { نوع: "ارجع", قيمة };
    }

    function محلل_الاذا() {
        تطابق("كلمة", "اذا");
        const شرط = محلل_التعبير();
        تطابق("اقواس", ":");

        const جسم = [];
        while (!تحقق("كلمة", "والا") && الموشر < رموز.length) {
            if (تحقق("سطر_جديد")) {
                التالي();
                continue;
            }
            جسم.push(محلل_جملة());
        }

        let والا_جسم = null;
        if (تطابق("كلمة", "والا")) {
            تطابق("اقواس", ":");
            والا_جسم = [];
            while (تحقق("سطر_جديد")) التالي();
            while (موشر < رموز.length && !تحقق("كلمة", "اذا")) {
                if (تحقق("سطر_جديد")) {
                    التالي();
                    continue;
                }
                والا_جسم.push(محلل_جملة());
            }
        }

        return { نوع: "اذا", شرط, جسم, والا: والا_جسم };
    }

    function محلل_جملة() {
        if (تحقق("كلمة", "اطبع")) return محلل_الطباعة();
        if (تحقق("كلمة", "نص")) return محلل_النص();
        if (تحقق("كلمة", "ارجع")) return محلل_الارجاع();
        if (تحقق("كلمة", "اذا")) return محلل_الاذا();

        const رمز = احصل();
        console.error(`جملة غير مفهومة عند السطر ${رمز?.سطر}:`, رمز);
        التالي(); // عشان يتخطى الرمز الغريب
        return { نوع: "غير_معروف", رمز };
    }

    function ابدأ() {
        const جمل = [];
        while (الموشر < رموز.length) {
            if (تحقق("سطر_جديد")) {
                التالي();
                continue;
            }
            جمل.push(محلل_جملة());
        }
        return { نوع: "برنامج", جمل };
    }

    return ابدأ();
}

module.exports = { محلل_الرموز };
