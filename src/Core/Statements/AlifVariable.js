import { احصل, تحقق, تطابق, المؤشر } from "../TokenUtils.js";
import { محلل_التعبير } from "../Expressions.js";

export function محلل_متغير(الرموز) {
    if (!الرموز || !Array.isArray(الرموز)) {
        throw new Error('الرموز غير معرفة أو غير صحيحة "محلل_متغير" ' + الرموز);
    }
    // دعم المتغيرات المتعددة مثل: س,ص = 7, 9
    const البداية = المؤشر;
    const أول = تطابق(الرموز, "معرف");
    if (!أول) return null;
    const أسماء = [أول.القيمة];
    // جمع أي معرفات إضافية مفصولة بفاصلة
    while (تحقق(الرموز, "فاصلة")) {
        تطابق(الرموز, "فاصلة");
        const t = تطابق(الرموز, "معرف");
        if (!t) {
            const error = new Error(`لا يوجد اسم متغير بعد الفاصلة`);
            error.line = `في السطر ` + احصل(الرموز).السطر;
            throw error;
        }
        أسماء.push(t.القيمة);
    }
    // تحقق من وجود علامة الإسناد
    if (تحقق(الرموز, "علامة_إسناد", "=") && تطابق(الرموز, "علامة_إسناد", "=")) {
        const قيم = [];
        const قيمة = محلل_التعبير(الرموز);
        if (!قيمة) {
            const error = new Error(`لا يوجد قيمة بعد علامة الإسناد`);
            error.line = `في السطر ` + احصل(الرموز).السطر;
            throw error;
        }
        قيم.push(قيمة);
        // جمع أي قيم إضافية مفصولة بفاصلة
        while (تحقق(الرموز, "فاصلة")) {
            تطابق(الرموز, "فاصلة");
            const قيمة = محلل_التعبير(الرموز);
            if (!قيمة) {
                const error = new Error(`لا يوجد قيمة بعد الفاصلة`);
                error.line = `في السطر ` + احصل(الرموز).السطر;
                throw error;
            }
            قيم.push(قيمة);
        }
        // إذا كان تعيين واحد فقط
        if (أسماء.length === 1 && قيم.length === 1) {
            return { نوع: "متغير", اسم: أسماء[0], قيمة: قيم[0] };
        }
        // تعيين متعدد
        return { نوع: "متغير_مجمع", أسماء, قيم };
    }
    // لا يوجد إسناد، أعد المؤشر
    المؤشر = البداية;
    return null;
}
