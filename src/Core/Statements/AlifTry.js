import { تحقق, تطابق } from "../TokenUtils.js";
import { إدارة_المسافة_البادئة } from "../Indentation.js";
import { إنشاء_الشفرة } from "../../AlifGenerator.js";

export function محلل_حاول(الرموز, الدالة_الام) {
    تطابق(الرموز, "كلمة", "حاول");
    تطابق(الرموز, "نقطتان");

    let اوامر_حاول = إدارة_المسافة_البادئة(الرموز, الدالة_الام, "حاول");
    if (!تحقق(الرموز, "مسافة")) {
        return { نوع: "حاول", اوامر_حاول };
    }

    return { نوع: "حاول", اوامر_حاول };
}
export function محلل_خلل(الرموز, الدالة_الام) {
    تطابق(الرموز, "كلمة", "خلل");
    تطابق(الرموز, "نقطتان");

    let اوامر_خلل = إدارة_المسافة_البادئة(الرموز, الدالة_الام, "خلل");
    if (!تحقق(الرموز, "مسافة")) {
        return { نوع: "خلل", اوامر_خلل };
    }

    return { نوع: "خلل", اوامر_خلل };
}
export function محلل_نهاية(الرموز, الدالة_الام) {
    تطابق(الرموز, "كلمة", "نهاية");
    تطابق(الرموز, "نقطتان");

    let اوامر_نهاية = إدارة_المسافة_البادئة(الرموز, الدالة_الام, "نهاية");
    if (!تحقق(الرموز, "مسافة")) {
        return { نوع: "نهاية", اوامر_نهاية };
    }

    return { نوع: "نهاية", اوامر_نهاية };
}

export function منشئ_حاول(مستوى, عداد, عقدة, داخل_برنامج) {
    if (!عقدة || typeof عقدة !== "object") {
        throw new Error("العقدة غير معرفة أو غير صحيحة في منشئ_حاول");
    }

    const اوامر_حاول = عقدة.اوامر_حاول || [];
    if (!Array.isArray(اوامر_حاول)) {
        throw new Error("اوامر_حاول غير معرفة أو غير صحيحة في منشئ_حاول");
    }

    let كود = "";

    if (عقدة.اوامر_حاول && عقدة.اوامر_حاول.length > 0) {
        const اوامر_حاول = عقدة.اوامر_حاول || [];
        if (!Array.isArray(اوامر_حاول)) {
            throw new Error("اوامر_حاول غير معرفة أو غير صحيحة في منشئ_حاول");
        }
        const القيم = اوامر_حاول
            .map((ج) => إنشاء_الشفرة(ج, مستوى + 1, عداد, داخل_برنامج))
            .join("\n");

        كود += `try {\n${القيم}\n}`;
    }

    if (عقدة.اوامر_خلل && عقدة.اوامر_خلل.length > 0) {
        const اوامر_خلل = عقدة.اوامر_خلل || [];
        if (!Array.isArray(اوامر_خلل)) {
            throw new Error("اوامر_خلل غير معرفة أو غير صحيحة في منشئ_حاول");
        }
        const القيم = اوامر_خلل
            .map((ج) => إنشاء_الشفرة(ج, مستوى + 1, عداد, داخل_برنامج))
            .join("\n");

        كود += `catch {\n${القيم}\n}`;
    }

    if (عقدة.اوامر_نهاية && عقدة.اوامر_نهاية.length > 0) {
        const اوامر_نهاية = عقدة.اوامر_نهاية || [];
        if (!Array.isArray(اوامر_نهاية)) {
            throw new Error("اوامر_نهاية غير معرفة أو غير صحيحة في منشئ_حاول");
        }
        const القيم = اوامر_نهاية
            .map((ج) => إنشاء_الشفرة(ج, مستوى + 1, عداد, داخل_برنامج))
            .join("\n");

        كود += `finally {\n${القيم}\n}`;
    }

    return كود;
}
